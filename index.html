<html>
  <head>
    <style>
      body {
          width: 1400;
          padding: 0;
          background-color: #fff;
          display: block;
          margin: 0 auto;
      }
      body canvas{
          margin: 0 auto;
      }

    </style>
    <script src="./pixi.dev.js"></script>
    <script src="./keydrown.min.js"></script>
    
   
  </head>
  <body>

  <script>
    var host = location.origin.replace(/^http/, 'ws')
    var ws = new WebSocket(host);
    var stream = null;

    ws.onmessage = function (event) {
      var datas =  event.data.split('\n');
      for (var i = 0; i <= datas.length; i++) {
        if(typeof(datas[i]) !=  "undefined" && datas[i] != ""){
          //console.log(datas[i]);
          stream = JSON.parse(datas[i]);
        }
      };
    };
  </script>
  <script>

    var graphics = []
    var scaleToPixel = 5;
    var fps = 60;
    var width = 1400;
    var height = 750;

    // create an new instance of a pixi stage
    var stage = new PIXI.Stage(0x000000);

    // create a renderer instance.
    var renderer = PIXI.autoDetectRenderer(width, height);

    // add the renderer view element to the DOM
    document.body.appendChild(renderer.view);
   
    requestAnimFrame(update);

    var b = new PIXI.Graphics();
    stage.addChild(b);

    function update() {
      kd.tick();
      b.clear();
      for (var i = 0; i < graphics.length; i++) {
        graphics[i].clear();
        graphics[i] = null;
      };
      graphics = [];
      setTimeout(function() {
        requestAnimFrame(update);
        var gamestate = stream;
        if(gamestate){
          for (var i = 0; i < gamestate.bots.length; i++) {
            drawShip(gamestate.bots[i],stage,graphics);
          }
          drawShip(gamestate.player,stage,graphics);
        }
      
        renderer.render(stage);
      }, 1000 / fps);

     
    }

    function convertX(x){
      return (x*scaleToPixel)+width/2;
    }

    function convertY(y){
      return (-y*scaleToPixel)+height/2;
    }
    
    function drawShip(ship,stage,graphics){
      ship.x = Number(ship.x);
      ship.y = Number(ship.y);
      ship.angle = Number(ship.angle);

      var g = new PIXI.Graphics();
      
      var paths = [
        [-1,1, -1,-1, 3,0],
        [-1,2, -1,-2, 1,0]
      ];
      
      g.lineStyle(1, 0xffd900, 1);
      g.beginFill(0x5D0776);

      for (var j = 0; j < paths.length; j++) {
        var path = paths[j];
        for (var i = 0; i < path.length; i++) {
          if(i % 2 == 0){
            path[i] = convertX(ship.x + path[i]);
          }else{
            path[i] = convertY(ship.y + path[i]);
          }
        }
      }

      g.drawPolygon(paths[0]);
      g.drawPolygon(paths[1]);
      g.endFill();

      g.pivot = new PIXI.Point(convertX(ship.x),convertY(ship.y));
      g.position.x = convertX(ship.x);
      g.position.y = convertY(ship.y);
      g.rotation = -ship.angle;
      stage.addChild(g);

      for (var i = 0; i < ship.bullets.length; i++) {
        ship.bullets[i].x = Number(ship.bullets[i].x);
        ship.bullets[i].y = Number(ship.bullets[i].y);
        var radius = 0.5;        
        b.lineStyle(1, 0xffd900, 1);
        b.beginFill(0x5D0776);
        b.drawCircle(convertX(ship.bullets[i].x),convertY(ship.bullets[i].y),radius * scaleToPixel);
        b.endFill();
      }
      graphics.push(g);
    }

  </script>

  <script>
  function EventControl(ws){
    
    this.ws = ws;

    this.sendkeyMessage = function (key,pressed){
      this.sendObject({event: key, pressed: pressed });  
    }

    this.sendNewPlayerMessage = function (){
      this.sendObject({event: "NEW_PLAYER"});
    }

    this.sendObject = function(obj){
      console.log("sendObject" +  obj);
      if(this.ws.readyState == 1){
        this.ws.send(JSON.stringify(obj)+ "\n")
      }
    }
  }

  var control = new EventControl(ws);

  //key pressed
  kd.LEFT.down(function () {
    control.sendkeyMessage("LEFT",true);
  });
  kd.UP.down(function () {
    control.sendkeyMessage("UP",true);
  });
  kd.DOWN.down(function () {
    control.sendkeyMessage("DOWN",true);
  });
  kd.RIGHT.down(function () {
    control.sendkeyMessage("RIGHT",true);
  });
  kd.S.down(function () {
    control.sendkeyMessage("FIRE",true);
  });

  //release key 
  kd.LEFT.up(function () {
    control.sendkeyMessage("LEFT",false);
  });
  kd.UP.up(function () {
    control.sendkeyMessage("UP",false);
  });
  kd.DOWN.up(function () {
    control.sendkeyMessage("DOWN",false);
  });
  kd.RIGHT.up(function () {
    control.sendkeyMessage("RIGHT",false);
  });
  kd.S.up(function () {
    control.sendkeyMessage("FIRE",false);
  });


  </script>

  <script>
    (function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame']
                                   || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
 
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());
  </script>
  </body>
</html>
