<html>
  <head>
    <style>
      body {
          width: 100%;
          height: 100%;
          padding: 0;
          background-color: black !important;
          display: block;
          margin: 0 auto;
          overflow: hidden;
      }

      .radar{
        width:300px;
        height:200px;
        position: absolute;
        top:20px;
        right:20px;
        background-color: transparent;
        border: 1px solid;
        border-color: #006600;
        overflow: hidden;
      }

      .circle {
        border-radius: 50%;
        width: 5px;
        height: 5px;
        position:absolute;
        background-color: red;
      }

    </style>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
  <div id="container">
  <div id="myModal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        
        <div class="modal-body">
          <input id="player_name" type="text" class="form-control" placeholder="Name please...">
          <br>
          <button onClick="eventsControl.addPlayer()" style="width: 100%;" type="submit" class="btn btn-primary" data-dismiss="modal">Play</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="radar" class="radar">
  </div>


  <script src="js/pixi.js"></script>
  <script src="js/fpsmeter.min.js"></script>
  <script src="js/keydrown.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script>

    $('#myModal').modal('show');
    var host = location.origin.replace(/^http/, 'ws')
    var ws = new WebSocket(host);
    var stream = null;

    ws.onmessage = function (event) {
      var datas =  event.data.split('\n');
      for (var i = 0; i <= datas.length; i++) {
        if(typeof(datas[i]) !=  "undefined" && datas[i] != ""){
          //console.log(datas[i]);
          stream = JSON.parse(datas[i]);
        }
      };
    };
    
    function CoordenateTranform(refpoint,scale,maxwidth,maxheight){
      this.scale = scale;
      this.maxwidth = maxwidth;
      this.maxheight = maxheight;
      this.refpoint = refpoint;

      function norm(point){
        return {  'x': point != null ? Number(point.x) : 0,
                  'y': point != null ? Number(point.y) : 0
        }
      }

      this.X = function(x){
        return ((x-norm(this.refpoint).x)*this.scale)+this.maxwidth/2 ;
      }

      this.Y = function(y){
        return ((-y+norm(this.refpoint).y)*this.scale)+this.maxheight/2;
      }

      this.unX = function(x){
        return (x - maxwidth/2)/scale + norm(this.refpoint).x 
      }

      this.unY = function(y){
        return (-y+maxheight/2)/scale +norm(this.refpoint).y 
      }
    }


    function Game(){
      this.mousepoint = {x:0,y:0};
      this.ships = {};
      
      this.width = $(document).width();
      this.height = $(document).height();  


      // create an new instance of a pixi stage
      this.stage = new PIXI.Container();


      // create ship texture
      this.shipTexture = PIXI.Texture.fromImage("ship_texture.png");

      // create moving background
      this.movingbg = new PIXI.extras.TilingSprite(
        PIXI.Texture.fromImage("grid_300x300.png"), this.width, this.height);
      this.movingbg.position.x = 0;
      this.movingbg.position.y = 0;
      this.movingbg.tilePosition.x = 0;
      this.movingbg.tilePosition.y = 0;

      // create graphics to bulltes TODO remove that
      this.graphics = new PIXI.Graphics();

      this.stage.addChild(this.movingbg);
      this.stage.addChild(this.graphics);

      
      //create coordenate tranform for radar
      var radarContainer = document.getElementById('radar');
      this.radarCoordenate = new CoordenateTranform(null,2,radarContainer.clientWidth,
        radarContainer.clientHeight);

      //create coordenate tranform for stage
      this.coordenate = new CoordenateTranform(null,15,this.width,this.height)


      // create a renderer instance.
      this.renderer = PIXI.autoDetectRenderer(this.width, this.height,{ transparent: true });

      // add the renderer view element to the DOM
      document.body.appendChild(this.renderer.view);
      window.addEventListener('resize', this.rescale, false);

      this.rescale = function() {
        this.width = this.width * window.innerWidth/this.width;
        this.height = this.width *  window.innerHeight/this.width;
        this.renderer.resize(this.width, this.height);
        this.movingbg.width = this.width
        this.movingbg.height = this.height;
      }

      this.update = function(gamestate) {
        this.graphics.clear();
      
        if(gamestate){
          //console.log("ships count: " + gamestate.ships.length);
          //finding player
          if(gamestate.player){
            if(!this.player){
              if(this.onNewPlayer){
                this.onNewPlayer(this.player);
              }
            }
            
            this.player = gamestate.player; // xy can change
            
            this.coordenate.refpoint = this.player;
            this.radarCoordenate.refpoint = this.player;

            gamestate.ships.push(gamestate.player);
          }
      
          //moving background
          //console.log(this.player)
          if(this.player){            
            this.movingbg.tilePosition.x = -(this.player.x*this.coordenate.scale)
            this.movingbg.tilePosition.y = (this.player.y*this.coordenate.scale)
          }

          // drawing ships
          for (var i = 0; i < gamestate.ships.length; i++) {
            this.drawShip(gamestate.ships[i],this.stage,this.ships,this.shipTexture);
          }

          //map ships easy access
          var shipsInGameState = {}
          for (var i = 0; i < gamestate.ships.length; i++) {
              shipsInGameState[Number(gamestate.ships[i].id)] = gamestate.ships[i];
          }
          

          //erase ships
          for(var id in this.ships){
            if(!shipsInGameState[Number(id)]){
              console.log("deleting id = " + id);
              console.log(this.ships[id])
              this.stage.removeChild(this.ships[id].sprite)
              this.ships[id].sprite = null;
              document.getElementById('radar').removeChild(this.ships[id].radar);
              delete this.ships[id];
            }
          }

          //send Mouse Position
          var point = this.renderer.plugins.interaction.mouse.global;
          if(this.mousepoint.x != point.x || this.mousepoint.y != point.y){
            this.mousepoint.x = point.x;
            this.mousepoint.y = point.y;
            this.onMouseMove(this.coordenate.unX(this.mousepoint.x),this.coordenate.unY(this.mousepoint.y));  
            console.log("player x,y: (" + this.player.x + "," + this.player.y + ")")
            console.log("player2 x,y: (" + this.coordenate.unX(this.coordenate.X(this.player.x)) + "," + this.coordenate.unY(this.coordenate.Y(this.player.y)) + ")")
          }
        }
        this.renderer.render(this.stage);
      }

      this.drawShip = function(ship,stage,ships,shipTexture){
        ship.x = Number(ship.x);
        ship.y = Number(ship.y);
        ship.angle = Number(ship.angle);

        var debug=false;
        if(debug){
        
          var paths = [
            [-1,2, -1,-2, 1,0],
            [-1,1, -1,-1, 3,0]
          ];
          
          for (var j = 0; j < paths.length; j++) {
            var path = paths[j];
            for (var i = 0; i < path.length; i++) {
              if(i % 2 == 0){
                path[i] = this.coordenate.X(ship.x + path[i]);
              }else{
                path[i] = this.coordenate.Y(ship.y + path[i]);
              }
            }
          }
          var g = new PIXI.Graphics() ;
          g.lineStyle(1, 0x000000, 1);
          g.beginFill(0x006600);
          g.drawPolygon(paths[0]);
          g.drawPolygon(paths[1]);
          g.endFill();
          g.position.x = this.coordenate.X(ship.x);
          g.position.y = this.coordenate.Y(ship.y);
          g.rotation = -ship.angle;
          g.pivot = new PIXI.Point(this.coordenate.X(ship.x),this.coordenate.Y(ship.y));
          stage.addChild(g);
        }

        var sprite = null
        var radar = null
        if(ships[ship.id]){
          sprite = ships[ship.id].sprite;
          radar = ships[ship.id].radar;
        }else{
          sprite = new PIXI.Sprite(shipTexture) ;
          ships[ship.id] = {}
          ships[ship.id].sprite = sprite;
          stage.addChild(sprite);

          radar = document.createElement("div");
          radar.className = 'circle';
          document.getElementById('radar').appendChild(radar);
          ships[ship.id].radar = radar;
        }

        var radarContainer = document.getElementById('radar');
        radar.style.top = this.radarCoordenate.Y(ship.y);
        radar.style.left = this.radarCoordenate.X(ship.x);
         
        sprite.width = sprite.height = 4 * this.coordenate.scale
        sprite.anchor.x = 0.5;
        sprite.anchor.y = 0.75;
        sprite.position.x = this.coordenate.X(ship.x);
        sprite.position.y = this.coordenate.Y(ship.y) ;
        sprite.rotation = -ship.angle + Math.PI/2;


        for (var i = 0; i < ship.bullets.length; i++) {
          ship.bullets[i].x = Number(ship.bullets[i].x);
          ship.bullets[i].y = Number(ship.bullets[i].y);
          var radius = 0.2;        
          this.graphics.lineStyle(1, 0x000000, 1);
          this.graphics.beginFill(0x006600);
          this.graphics.drawCircle(this.coordenate.X(ship.bullets[i].x),this.coordenate.Y(ship.bullets[i].y),radius * this.coordenate.scale);
          this.graphics.endFill();
        }
      }
    }

 
    function EventControl(ws){
    
      this.ws = ws;
      this.kd = kd;

      this.sendEvent = function (type,payload){
        var json = {event: type}
        if(payload){
          json["payload"] = payload;
        }
        this.sendObject(json);  
      }

      this.sendObject = function(obj){
        //console.log("sendObject");
        //console.log(obj);
        if(this.ws.readyState == 1){
          this.ws.send(JSON.stringify(obj)+ "\n")
        }
      }

      this.addPlayer = function(){
        var player_name = document.getElementById("player_name").value;
        this.sendEvent('NEW_PLAYER',{"user":{"name":player_name}})
      }

      this.initPlayerEventListener = function(){

        var _this = this
        //key pressed
        this.kd.LEFT.down(function () {
          _this.sendEvent("LEFT",{pressed: true});
        });
        this.kd.UP.down(function () {
          _this.sendEvent("UP",{pressed: true});
        });
        this.kd.DOWN.down(function () {
          _this.sendEvent("DOWN",{pressed: true});
        });
        this.kd.RIGHT.down(function () {
          _this.sendEvent("RIGHT",{pressed: true});
        });
        this.kd.S.down(function () {
          _this.sendEvent("FIRE",{pressed: true});
        });

        //release key 
        this.kd.LEFT.up(function () {
          _this.sendEvent("LEFT",{pressed: false});
        });
        this.kd.UP.up(function () {
          _this.sendEvent("UP",{pressed: false});
        });
        this.kd.DOWN.up(function () {
          _this.sendEvent("DOWN",{pressed: false});
        });
        this.kd.RIGHT.up(function () {
          _this.sendEvent("RIGHT",{pressed: false});
        });
        this.kd.S.up(function () {
          _this.sendEvent("FIRE",{pressed: false});
        });
      }

    } 

  var eventsControl = new EventControl(ws,kd);
  var game = new Game();
  var fps = new FPSMeter();


  game.onNewPlayer = function(player){
    eventsControl.initPlayerEventListener();
  }

  game.onMouseMove = function(x,y){
      console.log({'x':x,'y':y});
      eventsControl.sendEvent("MOUSE_MOVE",{'x':x,'y':y})
  }

  var refreshFrame = function(){
    game.update(stream);
    fps.tick();
    kd.tick();
    requestAnimationFrame(refreshFrame);
  }
  
  refreshFrame();

  </script>

  </div>
  </body>
</html>
