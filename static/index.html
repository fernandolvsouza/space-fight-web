<html>
  <head>
    <style>
      body {
          width: 100%;
          height: 100%;
          padding: 0;
          background-color: black !important;
          display: block;
          margin: 0 auto;
          overflow: hidden;
      }

      .radar{
        width:300px;
        height:200px;
        position: absolute;
        top:20px;
        right:20px;
        background-color: transparent;
        border: 1px solid;
        border-color: #006600;
        overflow: hidden;
      }

      .circle {
        border-radius: 50%;
        width: 5px;
        height: 5px;
        position:absolute;
        background-color: red;
      }

    </style>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
  <div id="container">
  <div id="myModal" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        
        <div class="modal-body">
          <input id="player_name" type="text" class="form-control" placeholder="Name please...">
          <br>
          <button onClick="control.addPlayer()" style="width: 100%;" type="submit" class="btn btn-primary" data-dismiss="modal">Play</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <div id="radar" class="radar">
  </div>


  <script src="js/pixi.js"></script>
  <script src="js/fpsmeter.min.js"></script>
  <script src="js/keydrown.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script>

    $('#myModal').modal('show');
    var host = location.origin.replace(/^http/, 'ws')
    var ws = new WebSocket(host);
    var stream = null;
    var player = null;

    ws.onmessage = function (event) {
      var datas =  event.data.split('\n');
      for (var i = 0; i <= datas.length; i++) {
        if(typeof(datas[i]) !=  "undefined" && datas[i] != ""){
          //console.log(datas[i]);
          stream = JSON.parse(datas[i]);
        }
      };
    };
    
  </script>
  <script>

    var meter = new FPSMeter();

    //console.log(document.body.width);
    var ships = {};
    var scaleToPixel = 15;
    var radarScaleToPixel = 2;
    var resize_ratio = 1
    var defaultWidth = width = $(document).width();
    var defaultHeight = height = $(document).height();  


    // create an new instance of a pixi stage
    var stage = new PIXI.Container();
    var shipTexture = PIXI.Texture.fromImage("ship_texture.png");
    var background = PIXI.Texture.fromImage("grid_300x300.png");
    var movingbg = new PIXI.extras.TilingSprite(background, width, height);
    
    movingbg.position.x = 0;
    movingbg.position.y = 0;
    movingbg.tilePosition.x = 0;
    movingbg.tilePosition.y = 0;
    stage.addChild(movingbg);

    // create a renderer instance.
    var renderer = PIXI.autoDetectRenderer(width, height,{ transparent: true });

    // add the renderer view element to the DOM
    document.body.appendChild(renderer.view);

    var b = new PIXI.Graphics();
    stage.addChild(b);

    window.addEventListener('resize', rescale, false);

    update()

    function rescale() {
      width = defaultWidth * window.innerWidth/defaultWidth;
      height = defaultHeight *  window.innerHeight/defaultHeight;
      renderer.resize(width, height);
      movingbg.width = width
      movingbg.height = height;
    }

    function update() {
      meter.tick();

      requestAnimationFrame(update);

      kd.tick();
      b.clear();
    
      var gamestate = stream;
      if(gamestate){
        
        //finding player
        if(gamestate.player){
          for (var i = 0; i < gamestate.players.length; i++) {
              if(gamestate.players[i].id == gamestate.player.id){
                player = gamestate.players[i]                
                //console.log(player)
              }
          }
          if(player){
            movingbg.tilePosition.x = -(player.x*scaleToPixel)
            movingbg.tilePosition.y = (player.y*scaleToPixel)
          }
        }
        // drawing bots
        for (var i = 0; i < gamestate.bots.length; i++) {
          drawShip(gamestate.bots[i],stage,ships);
        }

        // drawing players
        for (var i = 0; i < gamestate.players.length; i++) {
          drawShip(gamestate.players[i],stage,ships);
        }

      }
      renderer.render(stage);
    }

    function convertX(x,scale,w){
      scale = scale ? scale : scaleToPixel;
      w = w ? w : width;
      return ((x-Number(player != null? player.x : 0))*scale)+w/2 ;
    }

    function convertY(y,scale,h){
      scale = scale ? scale : scaleToPixel;
      h = h ? h : height;
      return (-(y-Number(player != null ? player.y : 0))*scale)+h/2;
    }

    function drawShip(ship,stage,ships){
      ship.x = Number(ship.x);
      ship.y = Number(ship.y);
      ship.angle = Number(ship.angle);

      var debug=false;
      if(debug){
      
        var paths = [
          [-1,2, -1,-2, 1,0],
          [-1,1, -1,-1, 3,0]
        ];
        
        for (var j = 0; j < paths.length; j++) {
          var path = paths[j];
          for (var i = 0; i < path.length; i++) {
            if(i % 2 == 0){
              path[i] = convertX(ship.x + path[i]);
            }else{
              path[i] = convertY(ship.y + path[i]);
            }
          }
        }
        var g = new PIXI.Graphics() ;
        g.lineStyle(1, 0x000000, 1);
        g.beginFill(0x006600);
        g.drawPolygon(paths[0]);
        g.drawPolygon(paths[1]);
        g.endFill();
        g.position.x = convertX(ship.x);
        g.position.y = convertY(ship.y);
        g.rotation = -ship.angle;
        g.pivot = new PIXI.Point(convertX(ship.x),convertY(ship.y));
        stage.addChild(g);
      }

      var sprite = null
      var radar = null
      if(ships[ship.id]){
        sprite = ships[ship.id].sprite;
        radar = ships[ship.id].radar;
      }else{
        sprite = new PIXI.Sprite(shipTexture) ;
        ships[ship.id] = {}
        ships[ship.id].sprite = sprite;
        stage.addChild(sprite);

        radar = document.createElement("div");
        radar.className = 'circle';
        document.getElementById('radar').appendChild(radar);
        ships[ship.id].radar = radar;
      }

      var radarContainer = document.getElementById('radar');
      radar.style.top = convertY(ship.y,radarScaleToPixel,radarContainer.clientHeight);
      radar.style.left = convertX(ship.x,radarScaleToPixel,radarContainer.clientWidth);
       
      sprite.width = sprite.height = 4 * scaleToPixel
      sprite.anchor.x = 0.5;
      sprite.anchor.y = 0.75;
      sprite.position.x = convertX(ship.x);
      sprite.position.y = convertY(ship.y) ;
      sprite.rotation = -ship.angle + Math.PI/2;


      for (var i = 0; i < ship.bullets.length; i++) {
        ship.bullets[i].x = Number(ship.bullets[i].x);
        ship.bullets[i].y = Number(ship.bullets[i].y);
        var radius = 0.5;        
        b.lineStyle(1, 0x000000, 1);
        b.beginFill(0x006600);
        b.drawCircle(convertX(ship.bullets[i].x),convertY(ship.bullets[i].y),radius * scaleToPixel);
        b.endFill();
      }
    }

  </script>

  <script>
 
    function EventControl(ws){
    
      this.ws = ws;
      this.kd = kd;

      this.sendEvent = function (type,payload){
        var json = {event: type}
        if(payload){
          json["payload"] = payload;
        }
        this.sendObject(json);  
      }

      this.sendObject = function(obj){
        console.log("sendObject");
        console.log(obj);
        if(this.ws.readyState == 1){
          this.ws.send(JSON.stringify(obj)+ "\n")
        }
      }

      this.addPlayer = function(){
        this.player = document.getElementById("player_name").value;
        this.sendEvent('NEW_PLAYER',{"user":{"name":this.player}})
        this.onNewPlayer();
      }

      this.onNewPlayer = function(){

        var _this = this
        //key pressed
        this.kd.LEFT.down(function () {
          _this.sendEvent("LEFT",{pressed: true});
        });
        this.kd.UP.down(function () {
          _this.sendEvent("UP",{pressed: true});
        });
        this.kd.DOWN.down(function () {
          _this.sendEvent("DOWN",{pressed: true});
        });
        this.kd.RIGHT.down(function () {
          _this.sendEvent("RIGHT",{pressed: true});
        });
        this.kd.S.down(function () {
          _this.sendEvent("FIRE",{pressed: true});
        });

        //release key 
        this.kd.LEFT.up(function () {
          _this.sendEvent("LEFT",{pressed: false});
        });
        this.kd.UP.up(function () {
          _this.sendEvent("UP",{pressed: false});
        });
        this.kd.DOWN.up(function () {
          _this.sendEvent("DOWN",{pressed: false});
        });
        this.kd.RIGHT.up(function () {
          _this.sendEvent("RIGHT",{pressed: false});
        });
        this.kd.S.up(function () {
          _this.sendEvent("FIRE",{pressed: false});
        });
      }

    } 

  var control = new EventControl(ws,kd)

  


  </script>

  <script>
    /*(function() {
    var lastTime = 0;
    var vendors = ['ms', 'moz', 'webkit', 'o'];
    for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
        window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame']
                                   || window[vendors[x]+'CancelRequestAnimationFrame'];
    }
 
    if (!window.requestAnimationFrame)
        window.requestAnimationFrame = function(callback, element) {
            var currTime = new Date().getTime();
            var timeToCall = Math.max(0, 16 - (currTime - lastTime));
            var id = window.setTimeout(function() { callback(currTime + timeToCall); },
              timeToCall);
            lastTime = currTime + timeToCall;
            return id;
        };
 
    if (!window.cancelAnimationFrame)
        window.cancelAnimationFrame = function(id) {
            clearTimeout(id);
        };
}());*/
  </script>
  </div>
  </body>
</html>
