<html>
  <head>
    <style>
      body {
          width: 100%;
          height: 100%;
          padding: 0;
          background-color: black !important;
          display: block;
          margin: 0 auto;
          overflow: hidden;
      }

      .radar{
        width:300px;
        height:200px;
        position: absolute;
        top:20px;
        right:20px;
        background-color: transparent;
        border: 1px solid;
        border-color: #006600;
        overflow: hidden;
      }

      ul.rank{
        list-style-type: decimal;
        width:200px;
        min-height: 20px;
        position: absolute;
        top:20px;
        left:3px;
        background-color: transparent;
        border: 2px solid;
        border-color: #006600;
        -webkit-border-radius: 6px;
        -moz-border-radius: 6px;
        border-radius: 6px;
        overflow: hidden;
      }

      ul.rank > li {
        
        height:30px;
        font-size: 20px;
        font-weight: bold;
        color: green;
      }
      ul.rank > li > span{
        float:right;
      }

      .lifebar{
        width:300px;
        height:20px;
        position: absolute;
        top:20px;
        left:40px;
        background-color: transparent;
        border: 1px solid;
        border-color: #006600;
      }

      .lifebar > div{
         background-color: green;
         width: 100%;
         height: 18px;
      }

      .status{
        font-size: 20px;
        position: absolute;
        top:17px;
        left:360px;
        vertical-align: top;
        background-color: transparent;
        color: green;
      }

      .circle {
        border-radius: 50%;
        width: 5px;
        height: 5px;
        position:absolute;
        background-color: red;
      }

      .front {
        z-index:1000;
      }

    </style>

    <link href="/css/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
  <div id="container">
  <div id="myModal" class="modal fade front">
    <div class="modal-dialog">
      <div class="modal-content">
        
        <div class="modal-body">
          <input id="player_name" type="text" class="form-control" placeholder="Name please...">
          <br>
          <button onClick="eventsControl.addPlayer()" style="width: 100%;" type="submit" class="btn btn-primary" data-dismiss="modal">Play</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <ul id="rank" class="rank">

  </ul>
  <div id="radar" class="radar">
  </div>
  <!--div id="lifebar" class="lifebar">
    <div id="progress"></div>
  </div-->

  <div id="status" class="status"></div>

  <script src="js/fpsmeter.min.js"></script>
  <script src="js/keydrown.min.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="bower_components/pixi.js/bin/pixi.js"></script>
  <script src="bower_components/pixi-particles/dist/pixi-particles.min.js"></script>
  <script src="lz-string/libs/lz-string.js"></script>
  
  
  <script>

    function decodeUtf8(arrayBuffer) {
      var result = "";
      var i = 0;
      var c = 0;
      var c1 = 0;
      var c2 = 0;

      var data = new Uint8Array(arrayBuffer);

      // If we have a BOM skip it
      if (data.length >= 3 && data[0] === 0xef && data[1] === 0xbb && data[2] === 0xbf) {
        i = 3;
      }

      while (i < data.length) {
        //console.log(String.fromCharCode(data[i]))
        c = data[i];

        if (c < 128) {
          result += String.fromCharCode(c);
          i++;
        } else if (c > 191 && c < 224) {
          if( i+1 >= data.length ) {
            throw "UTF-8 Decode failed. Two byte character was truncated.";
          }
          c2 = data[i+1];
          result += String.fromCharCode( ((c&31)<<6) | (c2&63) );
          i += 2;
        } else {
          if (i+2 >= data.length) {
            throw "UTF-8 Decode failed. Multi byte character was truncated.";
          }
          c2 = data[i+1];
          c3 = data[i+2];
          result += String.fromCharCode( ((c&15)<<12) | ((c2&63)<<6) | (c3&63) );
          i += 3;
        }
      }
      return result;
    }
    var c =0;
    function buildmessage(data){
      

      //CIRCLE, POLYGON, DEAD, BULLET, GARBAGE
      var ship_attrs = ['type','id','x','y','angle','energy','isbot','isdamaged','name','points'];
      var round_attrs = ['type','id','x','y','radius'];
      var base_attrs = ['type','id','x','y','radius','energy'];

      var data_types = [ 
        {
          name: 'circle',
          len:10,
          attrs:ship_attrs,
        },
        { 
          name: 'polygon',
          len:10,
          attrs:ship_attrs,
        },
        {
          name: 'dead',
          len:10,
          attrs:ship_attrs,
        },
        {
          name:'bullet',
          len:5,
          attrs:['type','id','x','y','angle']
        },
        {  
          name: 'sun',
          len:round_attrs.length,
          attrs: round_attrs
        },
        {   
          name: 'edge',
          len:0,
          attrs:[]
        },
        {   
          name: 'rank',
          len:31,
          attrs:[]
        },
        {   
          name: 'base',
          len: base_attrs.length,
          attrs: base_attrs
        }
      ];

      var parseRank = function(r_data){
        var rank = [];
        //console.log(r_data);
        for(var z=1;z<r_data.length;z+=3){
          rank.push({id:r_data[z],name:r_data[z+1],points:r_data[z+2]}); 
        }
        return rank
      }

      var parseEntity = function(type,data,attrs){
        //console.log("parseEntity");
        //console.log(type);
        //console.log(data);
        //console.log(attrs);
        if(data_types[type].name == 'rank')
          return parseRank(data);
        
        var entity = {}
        for(var i in data){
          if(attrs[i] == 'type'){
            entity[attrs[i]] = data_types[type].name;  
            continue;
          }
          entity[attrs[i]] = data[i];
        }
        //console.log(entity);
        return entity;
      }

      var entities = [];
      var rank = null;
      var totalbots = data.shift();
      var totalplayers = data.shift();
      var type_of_player = data[0];
      var player = parseEntity(type_of_player,data.splice(0,data_types[type_of_player].len),data_types[type_of_player].attrs);

      var i = 0;

      while(i < data.length){

        var type = data[i];
        var subdata = data.slice(i,i+data_types[type].len)
        //console.log("subdata:");
        //console.log(subdata);
        i+=data_types[type].len;
        var entity = parseEntity(type,subdata,data_types[type].attrs)

        switch(data_types[type].name) {
            case 'rank':
                rank = entity;  
                break;
            default:
              entities.push(entity);
        }
      }


      gamestate = {}
      if(rank) gamestate.rank = rank;
      gamestate.player = player;
      gamestate.entities = entities;
      gamestate.totalbots = totalbots;
      gamestate.totalplayers = totalplayers; 
      return gamestate;
    }


    $('#myModal').modal('show');
    var host = location.origin.replace(/^http/, 'ws')
    var ws = new WebSocket(host);
    var stream = null;
    var stream_count = 0;
    var laststreamtime = 0;
  
    var buffer = new ArrayBuffer(2000);
    var buffer_index = 0;

    ws.binaryType = 'arraybuffer';
    ws.onmessage = function (event) {

      var msg = new Uint8Array(event.data);
      
      if(msg){
        try{
          //var decoded_msg = decodeUtf8(msg);
          var decompressed_msg = LZString.decompressFromUint8Array(msg);
          stream = buildmessage(JSON.parse(decompressed_msg));
        }catch(e){
          console.log(e.stack);
          console.log("msg");
          console.log(msg);
          console.log("decompressed_msg");
          console.log(decompressed_msg);
          ws.close();
        }        
        
        stream_count ++;

        var now = performance.now();
        var delta = now - laststreamtime
        if(delta > 1000){
          console.log("datastreams by second : " + stream_count*1000/(delta));
          stream_count = 0;
          laststreamtime = now;
        }
      }
        

    };
    
    function CoordenateTranform(refpoint,scale,maxwidth,maxheight){
      this.scale = scale;
      this.maxwidth = maxwidth;
      this.maxheight = maxheight;
      this.refpoint = refpoint;

      function norm(point){
        return {  'x': point != null ? Number(point.x) : 0,
                  'y': point != null ? Number(point.y) : 0
        }
      }

      this.X = function(x){
        return ((x-norm(this.refpoint).x)*this.scale)+this.maxwidth/2 ;
      }

      this.Y = function(y){
        return ((-y+norm(this.refpoint).y)*this.scale)+this.maxheight/2;
      }

      this.unX = function(x){
        return (x - maxwidth/2)/scale + norm(this.refpoint).x 
      }

      this.unY = function(y){
        return (-y+maxheight/2)/scale +norm(this.refpoint).y 
      }

      this.unPoint = function(point){
        return {x:this.unX(point.x),y:this.unY(point.y)}
      }

      this.point = function(point){
        return {x:this.X(point.x),y:this.Y(point.y)}
      }
    }

    function GameRenderer(objects){
      this.objectsOnStage = objects;

      // create ship texture
      this.addToStage = function(update,coordenate,radarCoordenate,stage,player){

        var objectRender;
        if(update.type == "circle"){
          objectRender = new CircleShipRender(stage);
        }else if(update.type == "polygon"){
          objectRender = new PolygonShipRender(stage);
        } else if(update.type == "bullet"){
          objectRender = new BulletRender(stage);
        }else if(update.type == "sun"){
          objectRender = new SunRender(stage);
        }else if(update.type == "base"){
          objectRender = new BaseRender(stage);
        }

        if(!this.objectsOnStage[update.id]){
          this.objectsOnStage[update.id] = objectRender.createEntity(update,coordenate);
        }

        objectRender.update(this.objectsOnStage[update.id],update,coordenate,radarCoordenate,player);

      }

      this.removeFromStage = function(index,stage){
        
        stage.removeChild(this.objectsOnStage[index].sprite)
        this.objectsOnStage[index].sprite = null;
        
        if(this.objectsOnStage[index].radarpoint){
          stage.removeChild(this.objectsOnStage[index].name)
          this.objectsOnStage[index].name = null;
        }

        if(this.objectsOnStage[index].radarpoint)
          document.getElementById('radar').removeChild(this.objectsOnStage[index].radarpoint);

        if(this.objectsOnStage[index].energybar)
          stage.removeChild(this.objectsOnStage[index].energybar)

        if(this.objectsOnStage[index].body)
          stage.removeChild(this.objectsOnStage[index].body)

        delete this.objectsOnStage[index];

      }
    }

    var BaseRender = function(stage){
      this.stage = stage;
    }

    BaseRender.prototype.createEntity = function(base,coordenate){
        var entity = {};
        
        entity.body = new PIXI.Graphics();
        //entity.body.beginFill(0xffd900);
        entity.body.lineStyle(2, 0xffd900, 1);
        entity.body.drawCircle(0,0,base.radius * coordenate.scale);
        entity.body.endFill();
        this.stage.addChild(entity.body);


        entity.energybar = new PIXI.Graphics();
        entity.energybar.beginFill(0xffd900);
        entity.energybar.drawRect(0,0,10,5);
        entity.energybar.endFill();

        this.stage.addChild(entity.energybar);
        this.stage.addChild(entity.body);
        return entity;
    }

    BaseRender.prototype.update = function(entity,base,coordenate,radarCoordenate){

      
      entity.body.position.x = coordenate.X(Number(base.x));
      entity.body.position.y = coordenate.Y(Number(base.y)) ;

      entity.energybar.position.x  = entity.body.position.x - entity.energybar.width * 0.5;
      entity.energybar.position.y  = entity.body.position.y ;
      
      if(entity.energybar.width != base.energy){
        entity.energybar.width = base.energy/100 * 300 ;
      }
      
    }


    var SunRender = function(stage){
      this.stage = stage;
      this.texture = PIXI.Texture.fromImage('particle.png')
      
    }

    SunRender.prototype.createEntity = function(sun,coordenate){
        var entity = {};

        var sprite = new PIXI.Sprite(this.texture) ;      
        sprite.anchor.x = 0.5;
        sprite.anchor.y = 0.5;
        sprite.width = sprite.height = sun.radius * 3 *  2 * coordenate.scale;

        entity.sprite = sprite;
        this.stage.addChild(entity.sprite);
        return entity;
    }

    SunRender.prototype.update = function(entity,sun,coordenate,radarCoordenate){
      var sprite = entity.sprite;
      sprite.tint = 0xd9db1c;
      sprite.position.x = coordenate.X(Number(sun.x));
      sprite.position.y = coordenate.Y(Number(sun.y)) ;
      //sprite.rotation = -Number(sun.angle)+ Math.PI/2;
    }

    var BulletRender = function(stage){
      this.stage = stage;
      this.textures = {
        particle : PIXI.Texture.fromImage('particle.png')
      }
    }
    
    BulletRender.prototype.createEntity = function(bullet,coordenate){
        var entity = {}
        var container = new PIXI.Container();
        entity.emitter = new cloudkid.Emitter(
          container,
          this.textures.particle,
          {
            "alpha": {
              "start": 0.62,
              "end": 0
            },
            "scale": {
              "start": 0.25,
              "end": 0.75
            },
            "color": {
              "start": "#7ed995",
              "end": "#6bba2f"
            },
            "speed": {
              "start": 500,
              "end": 500
            },
            "startRotation": {
            "min": 89,
            "max": 91
            },
            "rotationSpeed": {
              "min": 50,
              "max": 50
            },
            "lifetime": {
              "min": 0.1,
              "max": 0.1
            },
            "blendMode": "normal",
            "frequency": 0.02,
            "emitterLifetime": -1,
            "maxParticles": 100,
            "pos": {
              "x": 0,
              "y": 0
            },
            "addAtBack": false,
            "spawnType": "circle",
            "spawnCircle": {
              "x": 0,
              "y": 0,
              "r": 0
            }
          }
        );
        entity.emitter.emit = true;
        entity.sprite = container;
        entity.lastupdate = Date.now();

        this.stage.addChild(entity.sprite);

        return entity;
    }

    BulletRender.prototype.update = function(entity,bullet,coordenate,radarCoordenate){
      var sprite = entity.sprite;
      sprite.position.x = coordenate.X(Number(bullet.x));
      sprite.position.y = coordenate.Y(Number(bullet.y)) ;
      sprite.rotation = -Number(bullet.angle)+ Math.PI/2;
      var now = Date.now();
      entity.emitter.update((now - entity.lastupdate) * 0.001)
      entity.lastupdate = now;
    }

    var BasicShipRender = function(){}

    BasicShipRender.prototype.createRadarPoint = function(){
      var radarpoint = document.createElement("div");
      radarpoint.className = 'circle';
      document.getElementById('radar').appendChild(radarpoint);
      return radarpoint;
    }

    BasicShipRender.prototype.setPositionInRadar = function(radarpoint,ship,radarCoordenate){
      var radarContainer = document.getElementById('radar');
      radarpoint.style.top = radarCoordenate.Y(Number(ship.y));
      radarpoint.style.left = radarCoordenate.X(Number(ship.x));
    } 

    var CircleShipRender = function(stage){
      this.stage = stage;
      this.tints = {
        bot: 0x00b300,
        damage: 0xe18410,
        normal: 0x000099,
      }
    }
    
    CircleShipRender.prototype = new BasicShipRender();
    
    CircleShipRender.prototype.createEntity = function(ship,coordenate){
        var entity = {};

        var sprite = new PIXI.Sprite(PIXI.Texture.fromImage('no-color3.png')) ;
        sprite.tint = ship.isbot ? this.tints.bot : this.tints.normal;
        sprite.anchor.x = 0.5;
        sprite.anchor.y = 0.5;
        sprite.width = sprite.height = 4 * coordenate.scale;

        entity.sprite = sprite;
        entity.radarpoint = this.createRadarPoint();
        this.stage.addChild(entity.sprite);

        if(!ship.isbot){
          entity.name = new PIXI.Text("", {font:"12px Arial", fill:"green"});
          entity.name.anchor.x = 0.0;
          entity.name.anchor.y = 0.5;
          this.stage.addChild(entity.name);
        }

        entity.energybar = new PIXI.Graphics();
        entity.energybar.beginFill(0xffd900);
        //entity.energybar.lineStyle(2, 0xffd900, 1);
        entity.energybar.drawRect(0,0,100,5);
        entity.energybar.endFill();
        this.stage.addChild(entity.energybar);

        return entity;
    }

    CircleShipRender.prototype.update = function(entity,ship,coordenate,radarCoordenate){
      var sprite = entity.sprite;
      sprite.position.x = coordenate.X(Number(ship.x));
      sprite.position.y = coordenate.Y(Number(ship.y)) ;
      sprite.rotation = -Number(ship.angle)+ Math.PI/2;

      entity.energybar.position.x  = sprite.position.x;
      entity.energybar.position.y  = sprite.position.y - sprite.height*0.75;
      
      if(entity.energybar.width != ship.energy){
        entity.energybar.width = ship.energy;
      }
      
      if(ship){
        if(!ship.isbot){
          entity.name.position.x = sprite.position.x;
          entity.name.position.y = sprite.position.y - sprite.height*0.85;

          var name = ship.points +" points "+ (ship.name ? " " + ship.name : "") 

          if(name != entity.name.text){
            entity.name.text = name;
          }
        }

        if(sprite.tint != this.tints.damage && ship.isdamaged){
          sprite.tint = this.tints.damage;
        }
        
        if(sprite.tint == this.tints.damage && !ship.isdamaged){  
          sprite.tint = ship.isbot ? this.tints.bot : this.tints.normal;
        }     

        this.setPositionInRadar(entity.radarpoint,ship,radarCoordenate);
      }
    }

    var PolygonShipRender = function(stage){
      this.stage = stage;
      this.texture = PIXI.Texture.fromImage("ship_texture.png");
    }

    PolygonShipRender.prototype = new BasicShipRender();
    
    PolygonShipRender.prototype.createEntity = function(ship,coordenate){
      var entity = {};

      var sprite = new PIXI.Sprite(ship.isbot ? this.texture.blue : this.texture.green) ;          
      sprite.anchor.x = 0.5;
      sprite.anchor.y = 0.75;
      sprite.width = sprite.height = 4 * coordenate.scale; 

      entity.sprite = sprite;
      entity.radarpoint = this.createRadarPoint();

      return entity;
    }

    PolygonShipRender.prototype.update = function(sprite,ship,coordenate,radarCoordenate){
      var sprite = entity.sprite;
      sprite.position.x = coordenate.X(Number(ship.x));
      sprite.position.y = coordenate.Y(Number(ship.y)) ;
      sprite.rotation = -Number(ship.angle) + Math.PI/2;

      this.setPositionInRadar(entity.radarpoint,ship,radarCoordenate);
    }


    function Game(){  
      var gamewidth = 500;
      this.gamewidth = gamewidth;
      this.gamemousepoint = {x:0,y:0};
      this.entitiesOnStage = {};
      this.gameEdges = [[-gamewidth/2,0],[gamewidth/2, 0],[gamewidth/2, gamewidth],[-gamewidth/2, gamewidth]];


      this.gameRenderer = new GameRenderer(this.entitiesOnStage);
      
      this.width = $(document).width();
      this.height = $(document).height();  


      // create an new instance of a pixi stage
      this.stage = new PIXI.Container();

      // create moving background
      this.movingbg = new PIXI.extras.TilingSprite(
        PIXI.Texture.fromImage("grid_300x300.png"), this.width, this.height);
      this.movingbg.position.x = 0;
      this.movingbg.position.y = 0;
      this.movingbg.tilePosition.x = 0;
      this.movingbg.tilePosition.y = 0;

      this.stage.addChild(this.movingbg);
      //create coordenate tranform for radar
      var radarContainer = document.getElementById('radar');
      this.radarCoordenate = new CoordenateTranform(null,2,radarContainer.clientWidth,
        radarContainer.clientHeight);

      //create coordenate tranform for stage
      this.coordenate = new CoordenateTranform(null,15,this.width,this.height)


      this.edges = new PIXI.Graphics();
      this.edges.beginFill(0x000000,0);
      this.edges.lineStyle(1, 0xffd900, 1);
      this.edges.moveTo(this.coordenate.scale*this.gameEdges[0][0],this.coordenate.scale*this.gameEdges[0][1]);
      this.edges.lineTo(this.coordenate.scale*this.gameEdges[1][0],this.coordenate.scale*this.gameEdges[1][1]);
      this.edges.lineTo(this.coordenate.scale*this.gameEdges[2][0],this.coordenate.scale*this.gameEdges[2][1]);
      this.edges.lineTo(this.coordenate.scale*this.gameEdges[3][0],this.coordenate.scale*this.gameEdges[3][1]);
      this.edges.lineTo(this.coordenate.scale*this.gameEdges[0][0],this.coordenate.scale*this.gameEdges[0][1]);
      this.edges.endFill();

      this.stage.addChild(this.edges);

      // create a renderer instance.
      this.renderer = PIXI.autoDetectRenderer(this.width, this.height,{ transparent: true });

      // add the renderer view element to the DOM
      document.body.appendChild(this.renderer.view);
      window.addEventListener('resize', this.rescale, false);

      this.rescale = function() {
        this.width = this.width * window.innerWidth/this.width;
        this.height = this.width *  window.innerHeight/this.width;
        this.renderer.resize(this.width, this.height);
        this.movingbg.width = this.width
        this.movingbg.height = this.height;
      }
      this.tries = 0

      this.update = function(gamestate) {
      
        if(gamestate){
          if(gamestate.rank){

            var html = ""
            for(i in gamestate.rank){

              if(gamestate.rank[i].name != "0"){
                html+= ("<li>" +(gamestate.rank[i].name ? gamestate.rank[i].name : "no name") + "</li>" )
              }
            }
            //q console.log($('#rank'));
            $('#rank').html(html);
          }

          if(gamestate.player && gamestate.player.type != "dead"){
            if(!this.player){
              if(this.onNewPlayer){
                this.onNewPlayer(this.player);
              }
            }
            
            this.player = gamestate.player; // xy can change
            
            this.coordenate.refpoint = this.player;
            this.radarCoordenate.refpoint = this.player;
            
            //var lifebar = document.getElementById('progress');
            //lifebar.style.width = this.player.energy + '%';

            //var status = document.getElementById('status');
            //status.innerHTML = gamestate.totalbots + ' bots ' + gamestate.totalplayers + (gamestate.totalplayers > 1 ? ' players '  : ' player');

            gamestate.entities.push(gamestate.player);
          }else{
            //var lifebar = document.getElementById('progress');
            //lifebar.style.width = '0%';
            if( $('#myModal').css('display') == 'none'){
              $('#myModal').modal('show');
            }

          }         
      
          //moving background
          //console.log(this.player)
          if(this.player){            
            this.movingbg.tilePosition.x = -(this.player.x*this.coordenate.scale).toFixed(0);
            this.movingbg.tilePosition.y = (this.player.y*this.coordenate.scale).toFixed(0);
          }


          this.edges.position.x = this.coordenate.X(0).toFixed(0);
          this.edges.position.y = this.coordenate.Y(this.gamewidth).toFixed(0);          
          

          var entities = gamestate.entities;
          
          // drawing entities
          for (var i = 0; i < entities.length; i++) {
            this.gameRenderer.addToStage(entities[i],this.coordenate,this.radarCoordenate,this.stage,this.player);
          }

          //map entities easy access
          var entitiesInGameState = {}
          for (var i = 0; i < entities.length; i++) {
              entitiesInGameState[Number(entities[i].id)] = entities[i];
          }

          //remove entities from stage
          for(var id in this.entitiesOnStage){
            if(!entitiesInGameState[id])
            {
              this.gameRenderer.removeFromStage(id,this.stage);
            }
          }

          //send Mouse Position
          var point = this.renderer.plugins.interaction.mouse.global;
          var gamepoint = {x:Number(this.coordenate.unX(point.x).toFixed(2)),y:Number(this.coordenate.unY(point.y).toFixed(2))}
          if(this.gamemousepoint.x != gamepoint.x || this.gamemousepoint.y != gamepoint.y){
            this.gamemousepoint.x = gamepoint.x;
            this.gamemousepoint.y = gamepoint.y;
            this.onMouseMove(this.gamemousepoint.x,this.gamemousepoint.y);  
          }
        }
        this.renderer.render(this.stage);
      }
    }

 
    function EventControl(ws){
    
      this.ws = ws;
      this.kd = kd;
      this.EVENTS = ['LEFT', 'RIGHT', 'UP', 'DOWN', 'FIRE', 'MOUSE_MOVE', 'NEW_PLAYER', 'REMOVE_PLAYER', 'BE_BORN', 'DIE'];

      this.sendEvent = function (type,payload){
        var array = [this.EVENTS.indexOf(type)]
        if(payload){
          for(var i in payload){
            if(typeof payload[i] == 'boolean'){
              payload[i] = payload[i] ? 1 : 0;
            }
            array.push(payload[i]);
          }
        }

        this.sendObject(array);  
      }

      this.sendObject = function(obj){
        //console.log("sendObject");
        //console.log(obj);
        if(this.ws.readyState == 1){
          this.ws.send(LZString.compressToUint8Array(JSON.stringify(obj)+ "\n"),{ binary: true, mask: true })

        }
      }

      this.addPlayer = function(){
        var player_name = document.getElementById("player_name").value;
        this.sendEvent('BE_BORN',{"name":player_name})
      }

      this.initPlayerEventListener = function(){

        var _this = this
        //key pressed
        this.kd.A.down(function () {
          _this.sendEvent("LEFT",{pressed: true});
        });
        this.kd.W.down(function () {
          _this.sendEvent("UP",{pressed: true});
        });
        this.kd.S.down(function () {
          _this.sendEvent("DOWN",{pressed: true});
        });
        this.kd.D.down(function () {
          _this.sendEvent("RIGHT",{pressed: true});
        });
        this.kd.SPACE.down(function () {
          _this.sendEvent("FIRE",{pressed: true});
        });

        //release key 
        this.kd.A.up(function () {
          _this.sendEvent("LEFT",{pressed: false});
        });
        this.kd.W.up(function () {
          _this.sendEvent("UP",{pressed: false});
        });
        this.kd.S.up(function () {
          _this.sendEvent("DOWN",{pressed: false});
        });
        this.kd.D.up(function () {
          _this.sendEvent("RIGHT",{pressed: false});
        });
        this.kd.SPACE.up(function () {
          _this.sendEvent("FIRE",{pressed: false});
        });
      }

    } 

  var eventsControl = new EventControl(ws,kd);
  var game = new Game();
  var fps = new FPSMeter();


  game.onNewPlayer = function(player){
    eventsControl.initPlayerEventListener();
  }

  game.onMouseMove = function(x,y){
      //console.log({'x':x,'y':y});
      eventsControl.sendEvent("MOUSE_MOVE",{'x':x,'y':y})
  }

  $(document).ready(function() {
    $(document).mousedown(function() {
        eventsControl.sendEvent("FIRE",{pressed: true});
    });

    $(document).mouseup(function() {
        eventsControl.sendEvent("FIRE",{pressed: false});
    });
  });

  var lastupdatetime = 0
  var updatetimeBysecond = 0
  
  var refreshFrame = function(){
    var before = performance.now();
    game.update(stream);
    var after = performance.now();
    
    var delta = after-before

    updatetimeBysecond = updatetimeBysecond + delta;
    
    if(after-lastupdatetime > 1000){
      //console.log("update time lost by second: " +updatetimeBysecond+  "miliseconds");
      lastupdatetime = after;
      updatetimeBysecond = 0;
    }

    fps.tick();
    kd.tick();
    requestAnimationFrame(refreshFrame);
  }
  
  refreshFrame();

  </script>

  </div>
  </body>
</html>
